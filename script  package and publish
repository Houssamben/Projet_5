
import sys
import json
import dataikuapi

def run_package_and_publish_use_case_indus(DESIGN_RD_USER_API_KEY, project_key, deployer_host, deployer_api_key, api_service_id, dict_automations):
    # Crée un client Dataiku
    client = dataikuapi.DSSClient('https://ds-studio', DESIGN_RD_USER_API_KEY, insecure_tls=True)
    macro_name = "pyrunnable_package-publish-use-case-indus_package-use-case-indus"
    project = client.get_project(project_key)
    macro = project.get_macro(macro_name)

    # Paramètres du macro
    params = {
        "deployer_host": deployer_host,
        "deployer_api_key": deployer_api_key,
        "api_service_id": api_service_id,
        "dict_automations": dict_automations
    }

    run_id = macro.run(params=params, wait=True)
    print("run_id :")
    print(run_id)

    status = macro.get_status(run_id)
    print("Status :")
    print(status)

    result = macro.get_result(run_id)
    print("Result : ")
    print(result)


if __name__ == "__main__":
    # Vérifier si tous les paramètres sont fournis
    if len(sys.argv) != 7:
        print("Usage: python run_package_and_publish_use_case_indus.py <DESIGN_RD_USER_API_KEY> <project_key> <deployer_host> <deployer_api_key> <api_service_id> <dict_automations_json>")
        sys.exit(1)

    # Récupérer les paramètres depuis la ligne de commande
    DESIGN_RD_USER_API_KEY = sys.argv[1]
    project_key = sys.argv[2]
    deployer_host = sys.argv[3]
    deployer_api_key = sys.argv[4]
    api_service_id = sys.argv[5]

    # dict_automations en JSON (convertir en dict)
    try:
        dict_automations = json.loads(sys.argv[6])
    except json.JSONDecodeError:
        print("Error: dict_automations must be valid JSON")
        sys.exit(1)

    print("Project_key :")
    print(project_key)

    run_package_and_publish_use_case_indus(
        DESIGN_RD_USER_API_KEY,
        project_key,
        deployer_host,
        deployer_api_key,
        api_service_id,
        dict_automations
    )

    print("Macro Package and publish use case indus run !")
